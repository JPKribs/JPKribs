name: Update Profile SVG
on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  generate-svg:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Fetch Real-Time Stats
        run: |
          # Fetching star counts from GitHub API
          SWIFT_STARS=$(curl -s https://api.github.com/repos/jellyfin/Swiftfin | jq -r '.stargazers_count')
          # Using 'K' formatting for Swiftfin if > 1000
          if [ "$SWIFT_STARS" -gt 1000 ]; then
            SWIFT_STARS_FORMATTED="$(echo "scale=1; $SWIFT_STARS/1000" | bc)k"
          else
            SWIFT_STARS_FORMATTED="$SWIFT_STARS"
          fi
          
          PROXY_STARS=$(curl -s https://api.github.com/repos/JPKribs/jellyfin-discovery-proxy | jq -r '.stargazers_count')
          POSTER_STARS=$(curl -s https://api.github.com/repos/JPKribs/jellyfin-plugin-episodepostergenerator | jq -r '.stargazers_count')
          UPDATED=$(date +'%b %d, %Y')

          cat <<EOF > profile-summary.svg
          <svg width="800" height="320" viewBox="0 0 800 320" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect width="800" height="320" rx="12" fill="#0d1117" stroke="#30363d"/>
            
            <text x="400" y="60" text-anchor="middle" font-family="Arial, sans-serif" font-size="32" font-weight="bold" fill="#f0f6fc">Joe Kribs</text>
            <text x="400" y="90" text-anchor="middle" font-family="Arial, sans-serif" font-size="16" fill="#8b949e">Jellyfin Team Member ‚Ä¢ Swiftfin Co-Maintainer</text>

            <rect x="50" y="130" width="220" height="110" rx="8" fill="#161b22" stroke="#F05138" stroke-width="1.5"/>
            <g transform="translate(148, 145) scale(0.5)">
              <path d="M42.3 3.6C40.6 2 34.2 0 24 0 11.4 0 0.8 8.6 0.8 21.4c0 14.2 11.6 24.2 25.8 24.2 10.9 0 18.3-6.7 20.2-9.1.5-.6.3-1.1-.3-1.1h-4.2c-.4 0-.7.2-.9.5-1.4 1.9-6.7 6.8-14.8 6.8-11.4 0-19.1-8.2-19.1-18.7 0-10.2 7.7-18.4 18.8-18.4 8.1 0 13 4.8 14.5 6.6.2.3.6.4.9.2l1.6-1.3c.3-.3.3-.8 0-1.1v-.4z" fill="#F05138"/>
            </g>
            <text x="160" y="195" text-anchor="middle" font-family="Arial, sans-serif" font-size="16" font-weight="bold" fill="#f0f6fc">Swiftfin</text>
            <text x="160" y="222" text-anchor="middle" font-family="Arial, sans-serif" font-size="14" fill="#8b949e">‚≠ê $SWIFT_STARS_FORMATTED Stars</text>

            <rect x="290" y="130" width="220" height="110" rx="8" fill="#161b22" stroke="#00ADD8" stroke-width="1.5"/>
            <g transform="translate(388, 145) scale(0.5)">
               <path d="M12.2 0c-4.4 0-7.8 1.2-10.1 3.4C.5 5.1 0 7.8 0 11.1c0 3.3.6 6 1.9 8.1 1.4 2.1 3.4 3.7 6.1 4.7 1.7.6 3.8.9 6.2.9 2.1 0 4.1-.2 5.8-.7 1.8-.5 3.3-1.2 4.4-2.1v-8.1H14v3.6h6.4v2.5c-.8.5-1.8.8-3.1 1-1.3.2-2.7.3-4.1.3-3.6 0-6.4-1-8.2-3.1-1.7-2-2.6-5-2.6-8.9s.9-6.8 2.6-8.9c1.8-2.1 4.5-3.1 8.2-3.1 2.3 0 4.3.4 5.9 1.2 1.6.8 2.8 2 3.5 3.5l3.2-1.9c-.9-1.9-2.5-3.5-4.7-4.6C24 1 20.8 0 17 0c-1.6 0-3.2.1-4.8.4v-.4z" fill="#00ADD8"/>
            </g>
            <text x="400" y="195" text-anchor="middle" font-family="Arial, sans-serif" font-size="16" font-weight="bold" fill="#f0f6fc">Discovery Proxy</text>
            <text x="400" y="222" text-anchor="middle" font-family="Arial, sans-serif" font-size="14" fill="#8b949e">‚≠ê $PROXY_STARS Stars</text>

            <rect x="530" y="130" width="220" height="110" rx="8" fill="#161b22" stroke="#512BD4" stroke-width="1.5"/>
            <g transform="translate(628, 145) scale(0.5)">
               <path d="M23.9 0C10.7 0 0 10.7 0 23.9s10.7 23.9 23.9 23.9 23.9-10.7 23.9-23.9S37.1 0 23.9 0zm0 43.1c-10.6 0-19.2-8.6-19.2-19.2S13.3 4.7 23.9 4.7s19.2 8.6 19.2 19.2-8.6 19.2-19.2 19.2zM14.5 24c0-5.2 4.2-9.4 9.4-9.4s9.4 4.2 9.4 9.4-4.2 9.4-9.4 9.4-9.4-4.2-9.4-9.4z" fill="#512BD4"/>
            </g>
            <text x="640" y="195" text-anchor="middle" font-family="Arial, sans-serif" font-size="16" font-weight="bold" fill="#f0f6fc">Poster Generator</text>
            <text x="640" y="222" text-anchor="middle" font-family="Arial, sans-serif" font-size="14" fill="#8b949e">‚≠ê $POSTER_STARS Stars</text>

            <line x1="50" y1="275" x2="750" y2="275" stroke="#30363d" />
            <text x="50" y="300" font-family="Arial, sans-serif" font-size="12" fill="#8b949e">üåê joseph.kribs.net  ‚Ä¢  ‚úâÔ∏è joseph@kribs.net</text>
            <text x="750" y="300" text-anchor="end" font-family="Arial, sans-serif" font-size="12" fill="#8b949e">üìç Littleton, CO ‚Ä¢ $UPDATED</text>
          </svg>
          EOF

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add profile-summary.svg
          git commit -m "chore: refresh profile stats" || exit 0
          git push
