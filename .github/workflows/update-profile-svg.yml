name: Update Profile SVG
on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  generate-svg:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Fetch Real-Time Stats
        run: |
          # Fetch star counts
          SWIFT_STARS=$(curl -s https://api.github.com/repos/jellyfin/Swiftfin | jq -r '.stargazers_count')
          if [ "$SWIFT_STARS" -gt 1000 ]; then
            SWIFT_STARS_FORMATTED="$(echo "scale=1; $SWIFT_STARS/1000" | bc)k"
          else
            SWIFT_STARS_FORMATTED="$SWIFT_STARS"
          fi
          
          PROXY_STARS=$(curl -s https://api.github.com/repos/JPKribs/jellyfin-discovery-proxy | jq -r '.stargazers_count')
          POSTER_STARS=$(curl -s https://api.github.com/repos/JPKribs/jellyfin-plugin-episodepostergenerator | jq -r '.stargazers_count')
          UPDATED=$(date +'%b %d, %Y')

          cat <<EOF > profile-summary.svg
          <svg width="800" height="320" viewBox="0 0 800 320" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect width="800" height="320" rx="12" fill="#0d1117" stroke="#30363d"/>
            
            <text x="400" y="60" text-anchor="middle" font-family="Arial, sans-serif" font-size="32" font-weight="bold" fill="#f0f6fc">Joe Kribs</text>
            <text x="400" y="90" text-anchor="middle" font-family="Arial, sans-serif" font-size="16" fill="#8b949e">Jellyfin Team Member ‚Ä¢ Swiftfin Co-Maintainer</text>

            <rect x="50" y="130" width="220" height="115" rx="8" fill="#161b22" stroke="#30363d"/>
            <g transform="translate(145, 145) scale(0.045)">
              <path d="M432.3 846.5c-44.4 0-101.9-19-158.4-53.5-120.4-73.4-180.3-176-180.3-294.6 0-160.2 124.6-281.4 286.7-281.4 117.8 0 200.7 67.8 221.7 89.6 4.9 5.2 3.6 11-1.3 15.3l-34.4 29.4c-4.3 3.6-10.4 4.3-15.3.3-14.7-11.6-90.3-67.6-170.8-67.6-131 0-218.6 96.7-218.6 215.1 0 102.2 60 188.5 168.6 254.8 55.4 33.7 110.2 52.4 153.3 52.4 5.9 0 11.1-.3 15.7-.9 6.2-.9 11.4 2.6 12.1 8.8l4.9 44.4c.7 5.9-2.9 11.1-8.8 11.7-10.8 1.5-24.8 1.5-35 1.5z" fill="#F05138"/>
            </g>
            <text x="160" y="195" text-anchor="middle" font-family="Arial, sans-serif" font-size="16" font-weight="bold" fill="#f0f6fc">Swiftfin</text>
            <text x="160" y="212" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#F05138">Swift</text>
            <text x="160" y="232" text-anchor="middle" font-family="Arial, sans-serif" font-size="14" fill="#8b949e">‚≠ê $SWIFT_STARS_FORMATTED Stars</text>

            <rect x="290" y="130" width="220" height="115" rx="8" fill="#161b22" stroke="#30363d"/>
            <g transform="translate(385, 145) scale(0.4)">
              <path d="M15.4 0C6.9 0 0 6.9 0 15.4s6.9 15.4 15.4 15.4c4.6 0 8.7-2.1 11.4-5.3l-3.8-2.6c-2 2.3-4.9 3.8-8.2 3.8-6 0-10.8-4.8-10.8-10.8S8.8 5.1 14.8 5.1c3.1 0 5.8 1.3 7.7 3.3l3.8-3.1C23.6 2.1 19.8 0 15.4 0zM26.4 12.8v4.5h13.2v-4.5H26.4z" fill="#00ADD8"/>
            </g>
            <text x="400" y="195" text-anchor="middle" font-family="Arial, sans-serif" font-size="16" font-weight="bold" fill="#f0f6fc">Discovery Proxy</text>
            <text x="400" y="212" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#00ADD8">Go</text>
            <text x="400" y="232" text-anchor="middle" font-family="Arial, sans-serif" font-size="14" fill="#8b949e">‚≠ê $PROXY_STARS Stars</text>

            <rect x="530" y="130" width="220" height="115" rx="8" fill="#161b22" stroke="#30363d"/>
            <g transform="translate(628, 145) scale(0.6)">
              <path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.6 0 12 0zm0 21.3c-5.1 0-9.3-4.2-9.3-9.3S6.9 2.7 12 2.7s9.3 4.2 9.3 9.3-4.2 9.3-9.3 9.3zm-2.7-13.8l6.6 4.5-6.6 4.5V7.5z" fill="#512BD4"/>
            </g>
            <text x="640" y="195" text-anchor="middle" font-family="Arial, sans-serif" font-size="16" font-weight="bold" fill="#f0f6fc">Poster Generator</text>
            <text x="640" y="212" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#512BD4">.NET</text>
            <text x="640" y="232" text-anchor="middle" font-family="Arial, sans-serif" font-size="14" fill="#8b949e">‚≠ê $POSTER_STARS Stars</text>

            <line x1="50" y1="275" x2="750" y2="275" stroke="#30363d" />
            <text x="50" y="300" font-family="Arial, sans-serif" font-size="12" fill="#8b949e">üåê joseph.kribs.net  ‚Ä¢  ‚úâÔ∏è joseph@kribs.net</text>
            <text x="750" y="300" text-anchor="end" font-family="Arial, sans-serif" font-size="12" fill="#8b949e">üìç Littleton, CO ‚Ä¢ $UPDATED</text>
          </svg>
          EOF

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add profile-summary.svg
          git commit -m "chore: refresh profile stats with official logos" || exit 0
          git push
