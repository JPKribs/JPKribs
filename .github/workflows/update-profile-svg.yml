name: Update Profile SVG
on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  generate-svg:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Fetch Real-Time Stats
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Fetch star counts
          SWIFT_STARS=$(curl -s https://api.github.com/repos/jellyfin/Swiftfin | jq -r '.stargazers_count')
          if [ "$SWIFT_STARS" -gt 1000 ]; then
            SWIFT_STARS_FORMATTED="$(echo "scale=1; $SWIFT_STARS/1000" | bc)k"
          else
            SWIFT_STARS_FORMATTED="$SWIFT_STARS"
          fi

          PROXY_STARS=$(curl -s https://api.github.com/repos/JPKribs/jellyfin-discovery-proxy | jq -r '.stargazers_count')
          POSTER_STARS=$(curl -s https://api.github.com/repos/JPKribs/jellyfin-plugin-episodepostergenerator | jq -r '.stargazers_count')
          UPDATED=$(date +'%b %d, %Y')

          # Fetch real GitHub activity data
          chmod +x .github/scripts/fetch-github-stats.sh
          eval "$(.github/scripts/fetch-github-stats.sh)"

          # Parse top 3 languages
          LANG1_NAME=$(echo "$TOP_LANGS" | sed -n '1p' | awk '{print $2}')
          LANG1_PCT=$(echo "$TOP_LANGS" | sed -n '1p' | awk '{print $1}')
          LANG2_NAME=$(echo "$TOP_LANGS" | sed -n '2p' | awk '{print $2}')
          LANG2_PCT=$(echo "$TOP_LANGS" | sed -n '2p' | awk '{print $1}')
          LANG3_NAME=$(echo "$TOP_LANGS" | sed -n '3p' | awk '{print $2}')
          LANG3_PCT=$(echo "$TOP_LANGS" | sed -n '3p' | awk '{print $1}')

          # Calculate bar widths (out of 200px max width)
          LANG1_WIDTH=$((LANG1_PCT * 2))
          LANG2_WIDTH=$((LANG2_PCT * 2))
          LANG3_WIDTH=$((LANG3_PCT * 2))

          # Get language colors
          case "$LANG1_NAME" in
            Swift) LANG1_COLOR="#F05138" ;;
            Go) LANG1_COLOR="#00ADD8" ;;
            "C#") LANG1_COLOR="#512BD4" ;;
            Python) LANG1_COLOR="#3776AB" ;;
            JavaScript) LANG1_COLOR="#F7DF1E" ;;
            TypeScript) LANG1_COLOR="#3178C6" ;;
            *) LANG1_COLOR="#8B949E" ;;
          esac

          case "$LANG2_NAME" in
            Swift) LANG2_COLOR="#F05138" ;;
            Go) LANG2_COLOR="#00ADD8" ;;
            "C#") LANG2_COLOR="#512BD4" ;;
            Python) LANG2_COLOR="#3776AB" ;;
            JavaScript) LANG2_COLOR="#F7DF1E" ;;
            TypeScript) LANG2_COLOR="#3178C6" ;;
            *) LANG2_COLOR="#8B949E" ;;
          esac

          case "$LANG3_NAME" in
            Swift) LANG3_COLOR="#F05138" ;;
            Go) LANG3_COLOR="#00ADD8" ;;
            "C#") LANG3_COLOR="#512BD4" ;;
            Python) LANG3_COLOR="#3776AB" ;;
            JavaScript) LANG3_COLOR="#F7DF1E" ;;
            TypeScript) LANG3_COLOR="#3178C6" ;;
            *) LANG3_COLOR="#8B949E" ;;
          esac

          # Copy template and substitute variables
          cp profile-summary-template.svg profile-summary.svg

          sed -i "s|SWIFT_STARS_FORMATTED|$SWIFT_STARS_FORMATTED|g" profile-summary.svg
          sed -i "s|PROXY_STARS|$PROXY_STARS|g" profile-summary.svg
          sed -i "s|POSTER_STARS|$POSTER_STARS|g" profile-summary.svg
          sed -i "s|UPDATED|$UPDATED|g" profile-summary.svg
          sed -i "s|TOTAL_COMMITS|$TOTAL_COMMITS|g" profile-summary.svg
          sed -i "s|YEAR_COMMITS|$YEAR_COMMITS|g" profile-summary.svg
          sed -i "s|CURRENT_YEAR|$CURRENT_YEAR|g" profile-summary.svg
          sed -i "s|BEST_STREAK|$BEST_STREAK|g" profile-summary.svg
          sed -i "s|TOTAL_POSTS|$TOTAL_POSTS|g" profile-summary.svg
          sed -i "s|TOTAL_REPLIES|$TOTAL_REPLIES|g" profile-summary.svg
          sed -i "s|TOTAL_DISCUSSIONS|$TOTAL_DISCUSSIONS|g" profile-summary.svg
          sed -i "s|LANG1_NAME|$LANG1_NAME|g" profile-summary.svg
          sed -i "s|LANG1_PCT|$LANG1_PCT|g" profile-summary.svg
          sed -i "s|LANG1_WIDTH|$LANG1_WIDTH|g" profile-summary.svg
          sed -i "s|LANG1_COLOR|$LANG1_COLOR|g" profile-summary.svg
          sed -i "s|LANG2_NAME|$LANG2_NAME|g" profile-summary.svg
          sed -i "s|LANG2_PCT|$LANG2_PCT|g" profile-summary.svg
          sed -i "s|LANG2_WIDTH|$LANG2_WIDTH|g" profile-summary.svg
          sed -i "s|LANG2_COLOR|$LANG2_COLOR|g" profile-summary.svg
          sed -i "s|LANG3_NAME|$LANG3_NAME|g" profile-summary.svg
          sed -i "s|LANG3_PCT|$LANG3_PCT|g" profile-summary.svg
          sed -i "s|LANG3_WIDTH|$LANG3_WIDTH|g" profile-summary.svg
          sed -i "s|LANG3_COLOR|$LANG3_COLOR|g" profile-summary.svg

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add profile-summary.svg
          git commit -m "chore: update profile SVG with latest stats" || exit 0
          git push
